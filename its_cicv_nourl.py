import time
import json
import socket
import urllib
import urllib.request
import random
from GeographicFrame import GeographicFrameEnu
from GIS import GIS

ORILAT=31.2828880548475
ORILON=121.171131134033
ORIALT=0
pulse = 0.1
tick = 0
if __name__ == '__main__':
    frameEnu = GeographicFrameEnu(ORILAT,ORILON,ORIALT)
    trafficProviderSocket = socket.socket()
    trafficProviderSocket.connect(("127.0.0.1", 21568))
    print("start data process node...\n")
    print("connect traffic provider ip: 127.0.0.1 port:21568")

    while (True):
        start = time.time()
        # url = "http://120.133.21.14:8090/gqApp/monitor/regionCloud/map?v2xId=210"
        # data = urllib.request.urlopen(url).read()
        # record=data.decode('UTF-8')
        # print(record)
# record -> src_data

        #src_data = [{"vid":3,"laneid":"123","coordinate":{"x":121.173791995,"y":31.2836465696,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":304.94431978549636,"speed":15.036970176916503,"vcolor":"ffff00","timestamp":1584541180997},{"vid":15,"laneid":"123","coordinate":{"x":121.170586868,"y":31.2842734022,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":262.1892855021238,"speed":12.133972491217381,"vcolor":"ffff00","timestamp":1584541180979},{"vid":0,"laneid":"123","coordinate":{"x":121.175913376,"y":31.2820755181,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":255.4547972588256,"speed":11.76947750278698,"vcolor":"ffff00","timestamp":1584541180971},{"vid":7,"laneid":"123","coordinate":{"x":121.172438387,"y":31.2842280725,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":288.6924562105008,"speed":12.25526097293814,"vcolor":"ffff00","timestamp":1584541181002},{"vid":5,"laneid":"123","coordinate":{"x":121.169657809,"y":31.2839982584,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":243.9278349037352,"speed":11.41737189166888,"vcolor":"ffff00","timestamp":1584541181001},{"vid":14,"laneid":"123","coordinate":{"x":121.171379575,"y":31.2843275755,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":271.30758435280825,"speed":13.731446103666208,"vcolor":"ffff00","timestamp":1584541180978},{"vid":13,"laneid":"123","coordinate":{"x":121.173987183,"y":31.2835709351,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":306.9034407623016,"speed":15.557059214336293,"vcolor":"ffff00","timestamp":1584541180976},{"vid":9,"laneid":"123","coordinate":{"x":121.170155451,"y":31.2841790998,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":252.2800062446717,"speed":11.891200600450832,"vcolor":"ffff00","timestamp":1584541181004},{"vid":12,"laneid":"123","coordinate":{"x":121.173048988,"y":31.283969868,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":115.02333456959714,"speed":14.476904318803369,"vcolor":"ffff00","timestamp":1584541180976},{"vid":10,"laneid":"123","coordinate":{"x":121.168640884,"y":31.2834897881,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":242.6801475203439,"speed":15.099156296171826,"vcolor":"ffff00","timestamp":1584541180973},{"vid":8,"laneid":"123","coordinate":{"x":121.175002369,"y":31.2827513499,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":326.40245368222077,"speed":13.016477861167619,"vcolor":"ffff00","timestamp":1584541181003},{"vid":11,"laneid":"123","coordinate":{"x":121.173543025,"y":31.2837458782,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":121.6683453967377,"speed":14.142669200919602,"vcolor":"ffff00","timestamp":1584541180975},{"vid":6,"laneid":"123","coordinate":{"x":121.172647538,"y":31.2841374175,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":289.4409733244722,"speed":14.508665125500936,"vcolor":"ffff00","timestamp":1584541181001},{"vid":1,"laneid":"123","coordinate":{"x":121.173661091,"y":31.2837591037,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":303.1514348197025,"speed":13.010598154334607,"vcolor":"ffff00","timestamp":1584541180972},{"vid":18,"laneid":"123","coordinate":{"x":121.172642786,"y":31.284173847,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":289.1301569676639,"speed":12.355123667755674,"vcolor":"ffff00","timestamp":1584541180981},{"vid":19,"laneid":"123","coordinate":{"x":121.175074531,"y":31.2824698345,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":150.7802408206227,"speed":6.010889673162741,"vcolor":"ffff00","timestamp":1584541180984},{"vid":17,"laneid":"123","coordinate":{"x":121.175245988,"y":31.282404486,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":333.93134177083687,"speed":13.032995864950912,"vcolor":"ffff00","timestamp":1584541180981},{"vid":16,"laneid":"123","coordinate":{"x":121.170382071,"y":31.2842374448,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":257.73665294553274,"speed":12.195277919475034,"vcolor":"ffff00","timestamp":1584541180980},{"vid":2,"laneid":"123","coordinate":{"x":121.170320403,"y":31.2841900035,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":256.0390903349017,"speed":13.915193575400302,"vcolor":"ffff00","timestamp":1584541180986},{"vid":22,"laneid":"123","coordinate":{"x":121.175336079,"y":31.2820427288,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":149.50214214696126,"speed":8.495960614046528,"vcolor":"ffff00","timestamp":1584541180989},{"vid":20,"laneid":"123","coordinate":{"x":121.175527229,"y":31.2820373738,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":284.7374316669369,"speed":14.08069648155412,"vcolor":"ffff00","timestamp":1584541180986},{"vid":23,"laneid":"123","coordinate":{"x":121.175488934,"y":31.28193185,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":120.0317967265884,"speed":12.135729215742153,"vcolor":"ffff00","timestamp":1584541180990},{"vid":21,"laneid":"123","coordinate":{"x":121.175211086,"y":31.2822441109,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":155.26845563889506,"speed":3.877588453538921,"vcolor":"ffff00","timestamp":1584541180988},{"vid":4,"laneid":"123","coordinate":{"x":121.173002203,"y":31.2840579397,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":294.55943480000457,"speed":14.206345658285603,"vcolor":"ffff00","timestamp":1584541181000},{"vid":25,"laneid":"123","coordinate":{"x":121.176250395,"y":31.2821054673,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":259.1667152069464,"speed":3.4448717675388134,"vcolor":"ffff00","timestamp":1584541180993},{"vid":26,"laneid":"123","coordinate":{"x":121.175260078,"y":31.2821409809,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":152.07021901009577,"speed":2.058426818773518,"vcolor":"ffff00","timestamp":1584541180994},{"vid":24,"laneid":"123","coordinate":{"x":121.168668737,"y":31.2834314613,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":62.59369350242566,"speed":11.42955970871062,"vcolor":"ffff00","timestamp":1584541180991},{"vid":27,"laneid":"123","coordinate":{"x":121.171018674,"y":31.2843135712,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":266.93630044555647,"speed":13.153400707762966,"vcolor":"ffff00","timestamp":1584541180994},{"vid":28,"laneid":"123","coordinate":{"x":121.166767073,"y":31.2828244874,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":255.99216610628287,"speed":14.912001775017522,"vcolor":"ffff00","timestamp":1584541180995},{"vid":29,"laneid":"123","coordinate":{"x":121.174681184,"y":31.2830703075,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":304.37757459327923,"speed":12.821184521847798,"vcolor":"ffff00","timestamp":1584541180996},{"vid":30,"laneid":"123","coordinate":{"x":121.175147726,"y":31.2823540355,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":153.24097891641622,"speed":5.063021222225494,"vcolor":"ffff00","timestamp":1584541180998},{"vid":31,"laneid":"123","coordinate":{"x":121.166711643,"y":31.2827805032,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":77.72213607816764,"speed":12.162149646352825,"vcolor":"ffff00","timestamp":1584541180998},{"vid":32,"laneid":"123","coordinate":{"x":121.167132662,"y":31.2828833839,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":73.60484548810764,"speed":13.919338721614894,"vcolor":"ffff00","timestamp":1584541180999},{"vid":33,"laneid":"123","coordinate":{"x":121.166368201,"y":31.2827213997,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":177.71028673499427,"speed":4.40401400847415,"vcolor":"ffff00","timestamp":1584541180999}]
        #src_data = [{"vid":3,"laneid":"123","coordinate":{"x":121.173791995,"y":31.2836465696,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":304.94431978549636,"speed":15.036970176916503,"vcolor":"ffff00","timestamp":1584541180997},{"vid":15,"laneid":"123","coordinate":{"x":121.170586868,"y":31.2842734022,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":262.1892855021238,"speed":12.133972491217381,"vcolor":"ffff00","timestamp":1584541180979},{"vid":0,"laneid":"123","coordinate":{"x":121.175913376,"y":31.2820755181,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":255.4547972588256,"speed":11.76947750278698,"vcolor":"ffff00","timestamp":1584541180971},{"vid":7,"laneid":"123","coordinate":{"x":121.172438387,"y":31.2842280725,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":288.6924562105008,"speed":12.25526097293814,"vcolor":"ffff00","timestamp":1584541181002},{"vid":5,"laneid":"123","coordinate":{"x":121.169657809,"y":31.2839982584,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":243.9278349037352,"speed":11.41737189166888,"vcolor":"ffff00","timestamp":1584541181001},{"vid":14,"laneid":"123","coordinate":{"x":121.171379575,"y":31.2843275755,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":271.30758435280825,"speed":13.731446103666208,"vcolor":"ffff00","timestamp":1584541180978},{"vid":13,"laneid":"123","coordinate":{"x":121.173987183,"y":31.2835709351,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":306.9034407623016,"speed":15.557059214336293,"vcolor":"ffff00","timestamp":1584541180976},{"vid":9,"laneid":"123","coordinate":{"x":121.170155451,"y":31.2841790998,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":252.2800062446717,"speed":11.891200600450832,"vcolor":"ffff00","timestamp":1584541181004},{"vid":12,"laneid":"123","coordinate":{"x":121.173048988,"y":31.283969868,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":115.02333456959714,"speed":14.476904318803369,"vcolor":"ffff00","timestamp":1584541180976},{"vid":10,"laneid":"123","coordinate":{"x":121.168640884,"y":31.2834897881,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":242.6801475203439,"speed":15.099156296171826,"vcolor":"ffff00","timestamp":1584541180973},{"vid":8,"laneid":"123","coordinate":{"x":121.175002369,"y":31.2827513499,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":326.40245368222077,"speed":13.016477861167619,"vcolor":"ffff00","timestamp":1584541181003},{"vid":11,"laneid":"123","coordinate":{"x":121.173543025,"y":31.2837458782,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":121.6683453967377,"speed":14.142669200919602,"vcolor":"ffff00","timestamp":1584541180975},{"vid":6,"laneid":"123","coordinate":{"x":121.172647538,"y":31.2841374175,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":289.4409733244722,"speed":14.508665125500936,"vcolor":"ffff00","timestamp":1584541181001},{"vid":1,"laneid":"123","coordinate":{"x":121.173661091,"y":31.2837591037,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":303.1514348197025,"speed":13.010598154334607,"vcolor":"ffff00","timestamp":1584541180972},{"vid":18,"laneid":"123","coordinate":{"x":121.172642786,"y":31.284173847,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":289.1301569676639,"speed":12.355123667755674,"vcolor":"ffff00","timestamp":1584541180981},{"vid":19,"laneid":"123","coordinate":{"x":121.175074531,"y":31.2824698345,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":150.7802408206227,"speed":6.010889673162741,"vcolor":"ffff00","timestamp":1584541180984},{"vid":17,"laneid":"123","coordinate":{"x":121.175245988,"y":31.282404486,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":333.93134177083687,"speed":13.032995864950912,"vcolor":"ffff00","timestamp":1584541180981}]
        #src_data = [{"vid":3,"laneid":"123","coordinate":{"x":121.173791995,"y":31.2836465696,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":304.94431978549636,"speed":15.036970176916503,"vcolor":"ffff00","timestamp":1584541180997},{"vid":15,"laneid":"123","coordinate":{"x":121.170586868,"y":31.2842734022,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":262.1892855021238,"speed":12.133972491217381,"vcolor":"ffff00","timestamp":1584541180979},{"vid":0,"laneid":"123","coordinate":{"x":121.175913376,"y":31.2820755181,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":255.4547972588256,"speed":11.76947750278698,"vcolor":"ffff00","timestamp":1584541180971},{"vid":7,"laneid":"123","coordinate":{"x":121.172438387,"y":31.2842280725,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":288.6924562105008,"speed":12.25526097293814,"vcolor":"ffff00","timestamp":1584541181002},{"vid":5,"laneid":"123","coordinate":{"x":121.169657809,"y":31.2839982584,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":243.9278349037352,"speed":11.41737189166888,"vcolor":"ffff00","timestamp":1584541181001},{"vid":14,"laneid":"123","coordinate":{"x":121.171379575,"y":31.2843275755,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":271.30758435280825,"speed":13.731446103666208,"vcolor":"ffff00","timestamp":1584541180978},{"vid":13,"laneid":"123","coordinate":{"x":121.173987183,"y":31.2835709351,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":306.9034407623016,"speed":15.557059214336293,"vcolor":"ffff00","timestamp":1584541180976},{"vid":9,"laneid":"123","coordinate":{"x":121.170155451,"y":31.2841790998,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":252.2800062446717,"speed":11.891200600450832,"vcolor":"ffff00","timestamp":1584541181004},{"vid":12,"laneid":"123","coordinate":{"x":121.173048988,"y":31.283969868,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":115.02333456959714,"speed":14.476904318803369,"vcolor":"ffff00","timestamp":1584541180976}]
        #src_data = [{"vid":3,"laneid":"123","coordinate":{"x":121.173791995,"y":31.2836465696,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":304.94431978549636,"speed":15.036970176916503,"vcolor":"ffff00","timestamp":1584541180997},{"vid":15,"laneid":"123","coordinate":{"x":121.170586868,"y":31.2842734022,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":262.1892855021238,"speed":12.133972491217381,"vcolor":"ffff00","timestamp":1584541180979},{"vid":0,"laneid":"123","coordinate":{"x":121.175913376,"y":31.2820755181,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":255.4547972588256,"speed":11.76947750278698,"vcolor":"ffff00","timestamp":1584541180971},{"vid":7,"laneid":"123","coordinate":{"x":121.172438387,"y":31.2842280725,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":288.6924562105008,"speed":12.25526097293814,"vcolor":"ffff00","timestamp":1584541181002},{"vid":5,"laneid":"123","coordinate":{"x":121.169657809,"y":31.2839982584,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":243.9278349037352,"speed":11.41737189166888,"vcolor":"ffff00","timestamp":1584541181001}]
        src_data = [{"vid":3,"laneid":"123","coordinate":{"x":121.173791995,"y":31.2836465696,"z":0.0},"linkid":"123","xacceleration":"3.5","vtype":70,"bearing":"0","wkid":"4326","courseAngle":350,"speed":15.036970176916503,"vcolor":"ffff00","timestamp":1584541180997}]
        json_str=json.dumps(src_data)
        # print(json_str)
        # print(type(json_str))
        #将JSON数据解码为dict（字典）
        datas = json.loads(json_str)

        for singleData in datas:
                # print ('---------')
                # print ('x:' + str(singleData['coordinate']['x']))
                # print ('y:' + str(singleData['coordinate']['y']))
                # print ('z:' + str(singleData['coordinate']['z']))
    #           print (singleData)
                
            out = frameEnu.WgsToLocal(float(singleData['coordinate']['y']), float(singleData['coordinate']['x']), float(singleData['coordinate']['z']))
                # print(out.x, out.y)
            
            actor = {}
            actor["Time"] = str(tick) #str(singleData['timestamp'])
            actor["Speed"] = str(singleData['speed'])
            actor["ID"] = str(singleData['vid'])
            actor["AssetID"] = str(1000000 + singleData['vid']) #str(random.randint(1000000,1000058))
            actor["Rotation"] = str(GIS.DegreeToRadian(singleData['courseAngle']))
            actor["PositionZ"] = str(singleData['coordinate']['z'] + 0.9)
            actor["PositionX"] = str(out.x)
            actor["PositionY"] = str(out.y)
 
            # print('ready to send:' + str(actor))
            try:
                trafficProviderSocket.send((json.dumps(actor) + '@').encode('utf-8'))
            except:
                print('traffic provider is closed: ' + str(singleData['timestamp']))
                
        end = time.time()
        print((end-start), len(datas))
        if ( pulse > (end-start)):
            print(pulse - (end-start))
            time.sleep(pulse - (end-start)) 
            
        tick = tick + pulse